import { z } from "genkit";
import { TotoRuntimeError, ValidationError } from "toto-api-controller";

/**
 * Models the data needed to send a task request TO an Agent (not to Gale Broker).
 * 
 * This is used by Gale Broker to send tasks to agents.
 */
export class AgentTaskRequest<T extends z.ZodTypeAny> {

    command: Command;
    taskId: TaskId;         // Unique identifier of the task to be executed. E.g. "text.summarize"
    taskInstanceId?: string; // Unique identifier for this specific execution of the task. This is generated by Gale Broker.
    taskInputData?: z.infer<T>;  // Input data needed for the task execution.
    correlationId?: string; // Correlation ID to group related tasks together.
    
    parentTask?: ParentTask; // Optional parent task information for tracking task hierarchies.

    constructor({command, taskId, taskInputData, correlationId, taskInstanceId, parentTask}: AgentTaskRequest<T>) {
        this.command = command;
        this.taskId = taskId;
        this.taskInputData = taskInputData;
        this.correlationId = correlationId;
        this.taskInstanceId = taskInstanceId;
        this.parentTask = parentTask;
    }

}

export interface ParentTask {
    taskId: TaskId;         // Unique identifier of the parent task.   
    taskInstanceId: string; // Unique identifier for this specific execution of the parent task.
}

/**
 * Models the data returned from an Agent after executing a task.
 */
export class AgentTaskResponse<T extends z.ZodTypeAny> {

    correlationId: string; // Correlation ID to group related tasks together.
    stopReason: StopReason; // Reason why the task execution stopped.
    taskOutput?: z.infer<T>;          // Output data produced by the task execution.

    constructor(stopReason: StopReason, correlationId: string, taskOutput?: z.infer<T>) {

        if (stopReason == 'subtasks') throw new ValidationError(400, "Only an OrchestratorAgent can return subtasks.");

        this.stopReason = stopReason;
        this.taskOutput = taskOutput;
        this.correlationId = correlationId;
    }

}

/**
 * Models the data returned from an Orchestrator Agent after executing a task.
 * Orchestrator agents can spawn subtasks.
 */
export class AgentTaskOrchestratorResponse<T extends z.ZodTypeAny> {

    correlationId: string;
    stopReason: StopReason;
    taskOutput?: z.infer<T>;
    subtasks?: SubTaskInfo[];

    constructor(stopReason: StopReason, correlationId: string, taskOutput?: z.infer<T>, subtasks?: SubTaskInfo[]) {
        this.stopReason = stopReason;
        this.taskOutput = taskOutput;
        this.subtasks = subtasks;
        this.correlationId = correlationId;
    }

}

export interface SubTaskInfo {
    taskId: TaskId;             // Unique identifier of the subtask to be executed.
    subtasksGroupId: string;    // Unique Group ID to group related subtasks together.
    taskInputData?: any;        // Input data needed for the subtask execution.
}

export type StopReason = "completed" | "failed" | "subtasks";

export type Command = StartCommand | ResumeCommand; 
export interface StartCommand {
    command: "start";
}
export interface ResumeCommand {
    command: "resume";
    completedSubtaskGroupId: string; // The ID of the group of subtasks that have been completed, triggering the resumption of the parent task.
}

export type TaskId = string;